<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Banana Puzzle Adventure ‚Äî Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg1:#0b3d2e; --bg2:#164a36; --accent:#ffb800; --accent2:#ffce00; }
    body { margin:0; min-height:100vh; background:linear-gradient(135deg,var(--bg1),var(--bg2)); font-family:"Poppins",sans-serif; color:#fff; text-align:center; padding:20px; }
    h1 { color:var(--accent2); margin:6px 0; }
    .meta { display:flex; gap:12px; justify-content:center; align-items:center; margin-bottom:10px; }
    .level-display { font-size:1.05rem; color:#dff6e6; }
    .timer { background:var(--accent); color:#222; padding:8px 14px; border-radius:20px; font-weight:700; }
    .progress { width:360px; max-width:94vw; height:10px; background:rgba(255,255,255,0.12); border-radius:20px; margin:8px auto; overflow:hidden; }
    .progress-bar { height:100%; width:100%; background:var(--accent); transition:width 1s linear; }

    .board { background:rgba(255,255,255,0.06); width:380px; max-width:96vw; margin:14px auto; padding:16px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.45); display:flex; flex-direction:column; align-items:center; }
    img.puz { width:100%; max-width:350px; border-radius:8px; border:2px solid var(--accent); display:block; }
    #userAnswer { width:120px; height:44px; margin-top:12px; font-size:1.15rem; text-align:center; border-radius:8px; border:none; background:#164a36; color:#fff; }
    .controls { margin-top:12px; display:flex; gap:8px; justify-content:center; }
    .btn { background:var(--accent); border:none; padding:10px 16px; border-radius:10px; font-weight:700; color:#222; cursor:pointer; }
    .btn.ghost { background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.08); }

    .message { margin-top:10px; min-height:1.2em; }

    
    .correct { animation: glow 900ms ease-out; }
    @keyframes glow { 0%{ box-shadow:0 0 6px #fff } 50%{ box-shadow:0 0 28px #ffd74d } 100%{ box-shadow:0 0 6px #fff } }

    
    .confetti {
      position:fixed; pointer-events:none; z-index:9999;
      width:10px; height:14px; opacity:0.95; transform:translateY(-20vh) rotate(10deg);
      animation: fall linear forwards;
    }
    @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

    
    .banana-top { font-size:34px; margin-bottom:4px; animation: smallBounce 1.2s infinite; }
    @keyframes smallBounce { 0%{ transform:translateY(0)} 50%{ transform:translateY(-6px)} 100%{ transform:translateY(0)} }
  </style>
</head>
<body>

  <div class="banana-top">üçå</div>
  <h1>Banana Puzzle Adventure</h1>

  <div class="meta">
    <div class="level-display" id="levelDisplay">Level: ‚Äî</div>
    <div class="timer" id="timer">Time: 0s</div>
  </div>

  <div class="progress"><div id="progressBar" class="progress-bar"></div></div>

  <div class="board" id="puzzleBoard">
    <div id="puzzleGrid">Loading puzzle‚Ä¶</div>
    <div class="controls">
      <button id="checkBtn" class="btn">Check Answer</button>
      <button id="nextBtn" class="btn" style="display:none;">Next Level ‚Üí</button>
    </div>
    <div class="message" id="message"></div>
  </div>

  <!-- sounds -->
  <audio id="sndCorrect" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="sndWrong" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
  <audio id="sndClick" src="https://actions.google.com/sounds/v1/ui/click.ogg"></audio>

<script>
/* -------------------------
   AUTH CHECK (cookie)

/*function getCookie(name) {
  const c = document.cookie.split('; ').find(r => r.trim().startsWith(name+'='));
  return c ? decodeURIComponent(c.split('=')[1]) : null;
}
if (!getCookie('username')) {
  window.location.href = 'login.html';
}
*/

let level = localStorage.getItem('selectedLevel') || 'Level 1';
document.getElementById('levelDisplay').innerText = 'Level: ' + level;

/* per-level time settings */
const levelTimes = {
  'Level 1': 70,
  'Level 2': 60,
  'Level 3': 50,
  'Level 4': 40,
  'Level 5': 30
};
let initialTime = levelTimes[level] || 60;
let timeLeft = initialTime;

const timerEl = document.getElementById('timer');
const progressBar = document.getElementById('progressBar');
timerEl.innerText = `Time: ${timeLeft}s`;
progressBar.style.width = '100%';

let timerInterval = setInterval(() => {
  timeLeft--;
  timerEl.innerText = `Time: ${timeLeft}s`;
  const pct = Math.max(0, (timeLeft / initialTime) * 100);
  progressBar.style.width = pct + '%';
  if (timeLeft <= 0) {
    clearInterval(timerInterval);
    document.getElementById('message').innerText = "‚è∞ Time's up!";
    document.getElementById('checkBtn').disabled = true;
  }
}, 1000);

/* -------------------------
   Banana API fetch 
 */
async function fetchPuzzle() {
  const grid = document.getElementById('puzzleGrid');
  grid.innerHTML = '<p>Loading puzzle‚Ä¶ üçå</p>';
  try {
    const res = await fetch('https://marcconrad.com/uob/banana/api.php');
    if (!res.ok) throw new Error('Network');
    const data = await res.json();
    renderPuzzle(data);
  } catch (err) {
    console.error(err);
    document.getElementById('puzzleGrid').innerHTML = '<p>‚ö†Ô∏è Could not load puzzle. Check connection.</p>';
    document.getElementById('checkBtn').disabled = true;
  }
}

function renderPuzzle(data) {
  const grid = document.getElementById('puzzleGrid');
  grid.innerHTML = `
    <img class="puz" src="${data.question}" alt="puzzle" />
    <input id="userAnswer" type="number" placeholder="Enter missing number" />
  `;
  grid.dataset.correct = data.solution;
  document.getElementById('checkBtn').disabled = false;
  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('message').innerText = '';
  const inp = document.getElementById('userAnswer'); if (inp) inp.focus();
}

function computeNextLevel(cur) {
  if (cur === 'Level 1') return 'Level 2';
  if (cur === 'Level 2') return 'Level 3';
  if (cur === 'Level 3') return 'Level 4';
  if (cur === 'Level 4') return 'Level 5';
  if (cur === 'Level 5') return 'Complete';
  return 'Level 1';
}
function scoringFor(lvl, tLeft) {
  const base = { 'Level 1':100, 'Level 2':140, 'Level 3':200, 'Level 4':270, 'Level 5':350 }[lvl] || 100;
  const mult = { 'Level 1':4, 'Level 2':5, 'Level 3':7, 'Level 4':9, 'Level 5':12 }[lvl] || 5;
  return base + (tLeft * mult);
}


function fireConfetti(count=20) {
  const colors = ['#ffd700','#ff6b6b','#6bffb8','#6bb8ff','#ffa36b'];
  for (let i=0;i<count;i++){
    const el = document.createElement('div');
    el.className='confetti';
    el.style.left = (10 + Math.random()*80) + 'vw';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.width = (6 + Math.random()*10) + 'px';
    el.style.height = (8 + Math.random()*14) + 'px';
    el.style.opacity = 0.95;
    el.style.animationDuration = (2 + Math.random()*2) + 's';
    el.style.transform = `translateY(-30vh) rotate(${Math.random()*360}deg)`;
    document.body.appendChild(el);
    // remove after animation
    setTimeout(()=> el.remove(), 3500);
  }
}

//UI handlers

document.getElementById('checkBtn').addEventListener('click', async () => {
  try { document.getElementById('sndClick').play().catch(()=>{}); } catch(e){}
  const grid = document.getElementById('puzzleGrid');
  const ansEl = document.getElementById('userAnswer');
  if (!ansEl) return;
  const user = ansEl.value.trim();
  const correct = grid.dataset.correct;
  if (user === '') { document.getElementById('message').innerText = 'Enter a number.'; return; }

  if (parseInt(user) === parseInt(correct)) {
    // win behavior
    clearInterval(timerInterval);
    document.getElementById('message').innerText = '‚úÖ Correct!';
    document.getElementById('puzzleGrid').classList.add('correct');
    try { document.getElementById('sndCorrect').play().catch(()=>{}); } catch(e){}
    fireConfetti(28);
    document.getElementById('nextBtn').style.display = 'inline-block';

    // scoring & save
    const username = localStorage.getItem('username') || getCookie('username') || 'Guest';
    const points = scoringFor(level, Math.max(0, timeLeft));
    const payload = { username: username, level: level, score_time: timeLeft, points: points };

    // send to backend (non-blocking)
    fetch('save_score.php', {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    }).then(r => r.json()).then(j => console.log('saved', j)).catch(err=>console.warn('save failed',err));
  } else {
    // wrong
    document.getElementById('message').innerText = '‚ùå Incorrect ‚Äî try again.';
    try { document.getElementById('sndWrong').play().catch(()=>{}); } catch(e){}
  }
});

/* next button flow */
document.getElementById('nextBtn').addEventListener('click', () => {
  const next = computeNextLevel(level);
  if (next === 'Complete') {
    alert('üéâ Completed all levels! Returning to Levels.');
    localStorage.removeItem('selectedLevel');
    window.location.href = 'levels.html';
  } else {
    localStorage.setItem('selectedLevel', next);
    window.location.reload();
  }
});

/* keyboard submit */
document.addEventListener('keydown', e => {
  const a = document.getElementById('userAnswer');
  if (a && document.activeElement === a && e.key === 'Enter') document.getElementById('checkBtn').click();
});


fetchPuzzle();
</script>
</body>
</html>

